---
title: "ã€Flutterã€‘Supabaseã§Sign in with Appleã‚’å®Ÿè£…"
emoji: "ğŸ’»"
type: "tech"
topics: [Flutter,Supabase,Apple,Tech]
published: true
---
# è¨˜äº‹ã®æ¦‚è¦
æœ¬è¨˜äº‹ã§ã¯ã€2023/04/13ã«[ã“ã¡ã‚‰](https://supabase.com/blog/supabase-auth-sso-pkce#:~:text=Start%20your%20project-,Back,Native%20Apple%20login%20on%20iOS,-While%20PKCE%20support)ã§ç™ºè¡¨ã•ã‚Œã¦ã„ã‚‹é€šã‚Šã€Supabaseã§Nativeã®Appleãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½(Sign in with Apple)ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€Flutterã‚¢ãƒ—ãƒªã‚’ç”¨ã„ã¦ãã®å…·ä½“çš„ãªå®Ÿè£…æ–¹æ³•ã‚’è§£èª¬ã™ã‚‹ã€‚

â€»1 æœ¬è¨˜äº‹ã§ã¯ã€Supabaseã®åŸºæœ¬äº‹é …ã«é–¢ã™ã‚‹èª¬æ˜(æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆæ–¹æ³•ãªã©)ã¯çœç•¥ã™ã‚‹ãŸã‚ã€Supabaseã®åŸºæœ¬ã‚’çŸ¥ã‚ŠãŸã„æ–¹ã¯ã€å…ˆã«[ã“ã¡ã‚‰](https://www.youtube.com/watch?v=XWYkpQRLsFk)ã®å‹•ç”»ãªã©ã‚’å‚è€ƒã«ã™ã‚‹ã€‚
â€»2 Nativeã®Appleãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã®åˆ©ç”¨ã«ã¯Apple Developerã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå¿…è¦ãªãŸã‚ã€Apple Developer Programã¸å‚åŠ ã—ã¦ã„ã‚‹ã“ã¨ãŒå‰æã§ã‚ã‚‹ã€‚

# å‰æçŸ¥è­˜
## Sign in with Appleã¨ã¯
[Sign in with Apple](https://developer.apple.com/jp/sign-in-with-apple/)ã§ã¯ã€AppleãŒApple IDã‚’åˆ©ç”¨ã—ãŸèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’æä¾›ã—ã¦ã„ã‚‹ã€‚ãƒ¦ãƒ¼ã‚¶ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸è¦ã§Face ID/Touch IDã§ã‚¢ãƒ—ãƒªã«ç™»éŒ²ã€ãƒ­ã‚°ã‚¤ãƒ³ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
Sign in with Appleã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚¢ãƒ—ãƒªã®æä¾›å´ã¯ã™ã§ã«æ‰¿èªã•ã‚Œã¦ã„ã‚‹Apple IDã‚’åˆ©ç”¨ã§ãã‚‹ãŸã‚ã€èªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…ã«ãŠã„ã¦æ§˜ã€…ãªåˆ©ç‚¹ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

# é–‹ç™ºç’°å¢ƒ
Flutter 3.7.0
iphoneå®Ÿæ©Ÿ(iOS 16.4.1)

# Sign in with Appleåˆ©ç”¨ã®ãŸã‚ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
**1. AppIDã®ç™»éŒ²**
[Apple Developer](https://developer.apple.com/)ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€Accountã‚¿ãƒ–ã‹ã‚‰è‡ªèº«ã®Developerã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€ä»¥ä¸‹ã®æ‰‹é †ã§AppIDã‚’ç™»éŒ²ã™ã‚‹ã€‚
1. Certificates, Identifiers&Profiles > Identifiersã‚’é–‹ã
2. +ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—
3. App IDsã‚’é¸æŠã—ã€Continue
4. Appã‚’é¸æŠã—ã€Continue
5. Descriptionã«ä»»æ„ã®èª¬æ˜ã‚’å…¥åŠ›
6. BundleIDã«Flutterã‚¢ãƒ—ãƒªã®BundleIDã‚’å…¥åŠ›
7. Capabilitiesã‚¿ãƒ–ã‹ã‚‰ã€ŒSign In with Appleã€ã«ãƒã‚§ãƒƒã‚¯
8. Continue
9. Register

**ï¼’. ServiceIDã®ç™»éŒ²**
åŒæ§˜ã«Apple Developerã‹ã‚‰ä»¥ä¸‹ã®æ‰‹é †ã§ServiceIDã‚’ç™»éŒ²ã™ã‚‹ã€‚
1. Certificates, Identifiers&Profiles > Identifiersã‚’é–‹ã
2. +ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—
3. Service IDsã‚’é¸æŠã—ã€Continue
4. Descriptionã«ä»»æ„ã®èª¬æ˜ã‚’å…¥åŠ›
5. Identifierã«BundleIDã®å…ˆé ­ã«ã€Œapp.ã€ã‚’è¿½åŠ ã—ãŸIDã‚’å…¥åŠ›(ä¾‹ app.com.test.project)
â€»AppIDã®ä½œæˆæ™‚ã«åˆ©ç”¨ã—ãŸBundleIDã¨åŒã˜ã‚‚ã®ã¯ä½¿ãˆãªã„ãŸã‚app.ãªã©ã‚’è¿½åŠ ã—ã¦å¯¾å¿œã™ã‚‹ã€‚
6. Continue
7. Register

**3. SecretKeyã®å–å¾—**
åŒæ§˜ã«Apple Developerã‹ã‚‰ä»¥ä¸‹ã®æ‰‹é †ã§SecretKeyã‚’å–å¾—ã™ã‚‹ã€‚
1. Certificates, Identifiers&Profiles > Keysã‚’é–‹ã
2. +ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—
3. Key Nameã«ä»»æ„ã®åå‰ã‚’å…¥åŠ›
4. ã€ŒSign In with Appleã€ã«ãƒã‚§ãƒƒã‚¯
5. ã€ŒSign In with Appleã€ã®å³å´ã®Configureã‚’ã‚¿ãƒƒãƒ—
6. ã‚¢ãƒ—ãƒªã®App IDã‚’é¸æŠ
7. Save
8. Continue
9. Register
10. Download

**4. client_secretã®ç”Ÿæˆ**
client_secretã®ç”Ÿæˆã«ruby-jwtã‚’åˆ©ç”¨ã™ã‚‹ã€‚RubyãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã¯[ã“ã¡ã‚‰](https://www.ruby-lang.org/ja/)ã‹ã‚‰äº‹å‰ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚
ä»¥ä¸‹ã®æ‰‹é †ã§client_secretã‚’ç”Ÿæˆã™ã‚‹ã€‚
1. ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ruby-jwtã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚
ãƒ»sudo gem install jwt
2. ä»»æ„ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ãã€ä»¥ä¸‹ã®å†…å®¹ã§secret_gen.rbãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚
key_file :ã€Œ3.SecretKeyã®å–å¾—ã€ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸAuthKey_XXXXXXXXXX.p8ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
team_id : TeamIDã€‚App Developerã®è‡ªèº«ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã®å³ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹IDã€‚
client_id : Certificates, Identifiers&Profiles > Identifiers > Service IDs > IDENTIFIERã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ID
key_id : Certificates, Identifiers&Profiles > Keys > ä½œæˆã—ãŸKeyã®è©³ç´° > Key ID
```dart:secret_gen.rb
require "jwt"

key_file = "Path to the private key"
team_id = "Your Team ID"
client_id = "The Service ID of the service you created"
key_id = "The Key ID of the private key"

validity_period = 180 # In days. Max 180 (6 months) according to Apple docs.

private_key = OpenSSL::PKey::EC.new IO.read key_file

token = JWT.encode(
	{
		iss: team_id,
		iat: Time.now.to_i,
		exp: Time.now.to_i + 86400 * validity_period,
		aud: "https://appleid.apple.com",
		sub: client_id
	},
	private_key,
	"ES256",
	header_fields=
	{
		kid: key_id
	}
)
puts token
```
3. secret_gen.rbã®ã‚ã‚‹ãƒ‘ã‚¹ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€client_secretã‚’ç”Ÿæˆã™ã‚‹ã€‚
ãƒ»ruby secret_gen.rb > client_secret.txt

**5. Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§Sign in with Appleã®æœ‰åŠ¹åŒ–**
[Supabase](https://app.supabase.com/projects)ã®ã‚¢ãƒ—ãƒªã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€Authentication > Providers > Appleã‹ã‚‰"Enable Apple provider"ã‚’ã‚ªãƒ³ã«ã—ã€ä»¥ä¸‹ã®è¨­å®šå†…å®¹ã§ä¿å­˜ã™ã‚‹ã€‚
IOS Bundle ID : Flutterã‚¢ãƒ—ãƒªã®Bundle ID
Secret key : ã€Œ4. client_secretã®ç”Ÿæˆã€ã§ä½œæˆã—ãŸã€client_secret.txtã®å†…å®¹
![](/images/apple_login_1.png =800x)


# Flutterã‚¢ãƒ—ãƒªå´ã®å®Ÿè£…æ‰‹é †
**1. Sign in with Appleã®æœ‰åŠ¹åŒ–**
Xcodeã§Flutterã‚¢ãƒ—ãƒªã‚’é–‹ãã€ã€Œ+Capabilityã€ã‚’ã‚¿ãƒƒãƒ—ã€ã€ŒSign In with Appleã€ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç™»éŒ²ã™ã‚‹ã€‚
![](/images/apple_login_2.png =800x)
![](/images/apple_login_3.png =800x)

**2. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
â€»Sign in with Appleã®åˆ©ç”¨ã«ã¯**supabase_flutter 1.7.0ä»¥ä¸Š**ãŒå¿…è¦ã€‚
```dart:pubspec.yaml
dependencies:
  supabase_flutter: ^1.8.1
```

**3. main.dartã®å®Ÿè£…**
ä»¥ä¸‹ã®é–¢æ•°ã‚’ç”¨ã„ã¦Sign in with Appleã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
```dart:main.dart
await supabase.auth.signInWithApple();
```
â€»signInWithAppleé–¢æ•°ã¯iOSã‚‚ã—ãã¯MacOSä¸Šã§ã®ã¿å‹•ä½œã™ã‚‹ã€‚ä»–ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§Appleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆ©ç”¨ã—ãŸã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’å®Ÿè£…ã™ã‚‹å ´åˆã¯ã€signInWithOAuthé–¢æ•°ã‚’åˆ©ç”¨ã™ã‚‹ã€‚

main.dartã®å®Ÿè£…ã‚³ãƒ¼ãƒ‰å…¨æ–‡ã¯ä»¥ä¸‹ã§ã‚ã‚‹ã€‚
:::details main.dart
```dart:main.dart
import 'package:flutter/material.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

void main() async {
  await Supabase.initialize(
    // â‘ Supabaseã®åˆæœŸåŒ–å‡¦ç†
    url: //è‡ªèº«ã®Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Project URLã®å€¤,
    anonKey: //è‡ªèº«ã®Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Project API keysã®anon keyã®å€¤,
  );
  runApp(MyApp());
}
 
// â‘¡Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆ
final supabase = Supabase.instance.client;
 
class MyApp extends StatelessWidget {
  MyApp({super.key});
 
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      theme: ThemeData(
        primarySwatch: Colors.blue,
      ),
      home: MyHomePage(title: 'Sign in with Apple'),
    );
  }
}
 
class MyHomePage extends StatefulWidget {
  MyHomePage({required this.title}) : super();
 
  final String title;
 
  @override
  _MyHomePageState createState() => _MyHomePageState();
}
 
class _MyHomePageState extends State<MyHomePage> {
  String _loginStatus = 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“';
 
  void _changeLoginStatus() {
    setState(() {
      _loginStatus = 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ';
    });
  }
 
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(widget.title),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: <Widget>[
            Text(
              _loginStatus,
            ),
            ElevatedButton(
              child: const Text('Sign in with Apple'),
              onPressed: () async {
                try {
                  // â‘¢Sign in with Appleã‚’å‘¼ã³å‡ºã™é–¢æ•°
                  await supabase.auth.signInWithApple();
                  // â‘£ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ããŸå ´åˆStateã‚’æ›´æ–°
                  _changeLoginStatus();
                } on AuthException catch (error) {
                  debugPrint(error.toString());
                } catch (error) {
                  debugPrint(error.toString());
                }
              },
            ),
          ],
        ),
      ),
    );
  }
}
```
:::


# å‹•ä½œç¢ºèª
â€»å‹•ä½œç¢ºèªã®ãŸã‚ã®ãƒ‡ãƒãƒƒã‚°ã§ã¯ã€ã‚·ãƒ¥ãƒŸãƒ¬ãƒ¼ã‚¿ã§ã¯ãªã**iphoneå®Ÿæ©Ÿ**(iOS:16.4.1)ã‚’åˆ©ç”¨ã€‚
1. ã‚¢ãƒ—ãƒªèµ·å‹•
![](/images/apple_login_4.png =400x)

2. Sign in with Appleã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚µã‚¤ãƒ³ã‚¤ãƒ³
![](/images/apple_login_5.png =400x)
![](/images/apple_login_6.png =400x)

3. Supabaseä¸Šã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹
![](/images/apple_login_7.png =800x)

# ã¾ã¨ã‚
Supabaseã‚’åˆ©ç”¨ã—ã¦ã€Flutterã§Sign in with Appleã‚’å®Ÿè£…ã—ãŸã€‚æœ¬è¨˜äº‹ã§ã¯ã€å®Ÿè£…ã™ã‚‹éš›ã®å°å…¥æ–¹æ³•ã‚’ä¸»ã«è§£èª¬ã—ã¦ã„ã‚‹ãŸã‚ç°¡å˜ãªå‹•ä½œç¢ºèªã®ã¿ã¨ãªã£ã¦ã„ã‚‹ãŒã€å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§åˆ©ç”¨ã™ã‚‹éš›ã¯ã€supabase.auth.onAuthStateChangeã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ã®èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç›£è¦–ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼ã‚’è²¼ã‚‹ã“ã¨ã§ã€ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†å¾Œã«ç”»é¢é·ç§»ã™ã‚‹ãªã©ã‚¢ãƒ—ãƒªã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

# å‚è€ƒ
[é–‹ç™ºè€…ã‚’é­…äº†ã™ã‚‹ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ Supabase ã¨ã¯ | AWS Dev Day 2022 Japan](https://www.youtube.com/watch?v=XWYkpQRLsFk)
[Supabase -Login with Apple](https://supabase.com/docs/guides/auth/social-login/auth-apple)
